<!DOCTYPE html>
<html lang="en-US" class="no-js">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8L0LM5E7J2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-8L0LM5E7J2');
</script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  

  
    
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Ansible - Tutorial rápido completo 2/2 | Hola, soy José Oliva</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Ansible - Tutorial rápido completo 2/2" />
<meta name="author" content="Teemo" />
<meta property="og:locale" content="es_ES" />
<meta name="description" content="Y este es mi blog personal" />
<meta property="og:description" content="Y este es mi blog personal" />
<link rel="canonical" href="https://noobchamp.github.io/ansible/linux/Ansible-configuracion-inicial-2/" />
<meta property="og:url" content="https://noobchamp.github.io/ansible/linux/Ansible-configuracion-inicial-2/" />
<meta property="og:site_name" content="Hola, soy José Oliva" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-24T11:45:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Ansible - Tutorial rápido completo 2/2" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@Teemo" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Teemo"},"dateModified":"2022-09-24T11:45:00+00:00","datePublished":"2022-09-24T11:45:00+00:00","description":"Y este es mi blog personal","headline":"Ansible - Tutorial rápido completo 2/2","mainEntityOfPage":{"@type":"WebPage","@id":"https://noobchamp.github.io/ansible/linux/Ansible-configuracion-inicial-2/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://noobchamp.github.io/images/joseoliva.webp"},"name":"Teemo"},"url":"https://noobchamp.github.io/ansible/linux/Ansible-configuracion-inicial-2/"}</script>
<!-- End Jekyll SEO tag -->


  

  <script>
    /* Cut the mustard */
    if ( 'querySelector' in document && 'addEventListener' in window ) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/skins/default.css">
  <!-- 
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,400i,700,700i|Lora:400,400i,700,700i">
   --><link rel="alternate" type="application/atom+xml" title="Hola, soy José Oliva" href="/atom.xml">
<!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
<link rel="manifest" href="/images/favicon/site.webmanifest">
<link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<!-- end custom head snippets -->

</head>

  <body class="layout--post  ansible-tutorial-rápido-completo-2-2">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Saltar enlaces</h2>
  <ul>
    <li><a href="#primary-nav" class="screen-reader-shortcut">Saltar a la navegación primaria</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Saltar al contenido</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Saltar al pie de página</a></li>
  </ul>
</nav>

    
  <div class="navigation-wrapper">
    <a href="#menu-toggle" id="menu-toggle">Menú</a>
    <nav id="primary-nav" class="site-nav animated drop">
      <ul><li><a href="/">Home</a></li><li><a href="/posts/">Posts</a></li><li><a href="/categories/">Categories</a></li><li><a href="/tags/">Tags</a></li><li><a href="/search/">Search</a></li></ul>
    </nav>
  </div><!-- /.navigation-wrapper -->


    <header class="masthead">
  <div class="wrap">
    
      <a href="/" class="site-logo" rel="home" title="Hola, soy José Oliva">
        <img src="/images/joseoliva.webp" class="site-logo-img animated fadeInDown" alt="Hola, soy José Oliva">
      </a>
    
    
    
      
        <div class="site-title animated fadeIn"><a href="/">Hola, soy José Oliva</a></div>
      
      <p class="site-description animated fadeIn" itemprop="description">Y este es mi blog personal</p>
    
  </div>
</header><!-- /.masthead -->


    <main id="main" class="main-content" aria-label="Content">
  <article class="h-entry">
    

    <div class="page-wrapper">
      <header class="page-header">
        
        
          <h1 id="page-title" class="page-title p-name">Ansible - Tutorial rápido completo 2/2
</h1>
        
      </header>

      <div class="page-sidebar">
        <div class="page-author h-card p-author"><img src="/images/teemo.webp" class="author-avatar u-photo" alt="Teemo"><div class="author-info"><div class="author-name">
        <em>por</em> <span class="p-name">Teemo</span>
      </div><ul class="author-links"><li class="author-link">
            <a class="u-url" rel="me" href="https://www.linkedin.com/in/joseaoliva/"><i class="fab fa-linkedin fa-lg" title="Linkedin"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://github.com/noobchamp"><i class="fab fa-github fa-lg" title="Github"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://www.instagram.com/teemo__dachshund/"><i class="fab fa-instagram fa-lg" title="Instagram"></i></a>
          </li></ul>

<span class="read-time">9 minuto(s) de lectura</span>

    <time class="page-date dt-published" datetime="2022-09-24T11:45:00+00:00"><a class="u-url" href="">24 de September 2022</a>
</time>

  </div>
</div>

        
  <h3 class="page-taxonomies-title">Categorías</h3>
  
  <ul class="page-taxonomies"><li class="page-taxonomy"><a class="p-category" href="/categories/#ansible" title="Páginas archivadas bajo Ansible">Ansible</a></li><li class="page-taxonomy"><a class="p-category" href="/categories/#linux" title="Páginas archivadas bajo Linux">Linux</a></li>
  </ul>


        
  <h3 class="page-taxonomies-title">Etiquetas</h3>
  
  <ul class="page-taxonomies"><li class="page-taxonomy"><a href="/tags/#ansible" title="Páginas etiquetadas Ansible" rel="tag">Ansible</a></li><li class="page-taxonomy"><a href="/tags/#centos" title="Páginas etiquetadas CentOS" rel="tag">CentOS</a></li><li class="page-taxonomy"><a href="/tags/#red-hat" title="Páginas etiquetadas Red Hat" rel="tag">Red Hat</a></li>
  </ul>


      </div>

      <div class="page-content">
        <div class="e-content">
          <p><img src="/images/ansible.webp" alt="center-aligned-image" class="align-center" /></p>

<h2 id="introducción">Introducción</h2>

<p>En el <a href="https://noobchamp.github.io/ansible/linux/Ansible-configuracion-inicial-1/">anterior post</a> vimos lo básico de <code class="language-plaintext highlighter-rouge">Ansible</code>. Aunque con nuestro inventario podemos lanzar prácticamente cualquier módulo por línea de comandos, lo ideal es hacer una estructura y usar todo lo disponible a nuestro alcance.</p>

<p>Ahora vamos a ver playbooks, handlers, tags, collections, vault, roles y ansible-galaxy. Estas cosas son las que hacen que <code class="language-plaintext highlighter-rouge">ansible</code> sea tan útil.
Vamos a ver cada uno y entremedias veremos otras cosillas como el vault, al final va a ser un revuelto pero la cosa es ver cómo trabajan juntos puesto que por separado no es eficiente.</p>

<blockquote>
  <p>Las opciones de los comandos se han explicado en el anterior post.
Recuerda que la opción <code class="language-plaintext highlighter-rouge">-C</code> va a simular la ejecución pero no la llevará a cabo.</p>
</blockquote>

<h2 id="playbook">Playbook</h2>

<p>Un playbook nos sirver para ejecutar específicas tareas sobre específicos servidores. Por supuesto tiene sintaxis yamel.</p>

<p>Mejor vamos a explicar con un ejemplo, vamos a crear el primer playbook. Como vimos anteriormente todo lo hacemos como root pero vamos a crear el usuario ansible y copiar la <em>rsa</em> a cada máquina.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">micluster</span>
  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Crear el usuario ansible</span>
      <span class="na">user</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">ansible</span>
        <span class="na">shell</span><span class="pi">:</span> <span class="s">/bin/bash</span>
        <span class="c1">#password:</span>
        <span class="na">generate_ssh_key</span><span class="pi">:</span> <span class="s">yes</span>
        <span class="na">ssh_key_bits</span><span class="pi">:</span> <span class="m">2048</span>
        <span class="na">ssh_key_file</span><span class="pi">:</span> <span class="s">.ssh/id_rsa</span>
</code></pre></div></div>

<p>Y comprobamos que pasaría (lanzamos a un solo nodo):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@ansible miansible]# ansible-playbook crearusuario.yml <span class="nt">-i</span> inventory.yml <span class="nt">-l</span> nodo1 <span class="nt">-C</span>

PLAY <span class="o">[</span>micluster] <span class="k">*******************************************************************************************************************************************************************************</span>

TASK <span class="o">[</span>Gathering Facts] <span class="k">*************************************************************************************************************************************************************************</span>
ok: <span class="o">[</span>nodo1]

TASK <span class="o">[</span>Crear el usuario ansible] <span class="k">****************************************************************************************************************************************************************</span>
changed: <span class="o">[</span>nodo1]

PLAY RECAP <span class="k">*************************************************************************************************************************************************************************************</span>
nodo1                      : <span class="nv">ok</span><span class="o">=</span>2    <span class="nv">changed</span><span class="o">=</span>1    <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>0    <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
</code></pre></div></div>

<p>Como vemos en el playbook, no tenemos clave para este usuario, en Linux se puede crear el usuario pero no proporcionar contraseña.
Esa es la línea que tenemos comentada, pero como no queremos pasar contraseñas en texto plano vamos a la siguiente cuestión.</p>

<h2 id="vault">Vault</h2>

<p>No es más que un gestor de contraseñas (por así llamarlo). Se usa para cifrar las claves y no enviarlas en texto plano. Además te permite poder subir tu proyecto incluida las contraseñas puesto que usa una <em>contraseña maestra</em>.</p>

<p>Primero vamos a crear el archivo</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@ansible miansible]# ansible-vault create vault.yml
New Vault password: 
Confirm New Vault password: 
<span class="c"># En mi caso he puesto secreto123, sera la contraseña maestra</span>
</code></pre></div></div>

<p>Directamente entra en el editor vi (puedes cambiarlo), si no sabes salir pulsa <em>esc</em> y <em>:wq</em>.<br />
He agregado la entrada:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">ansible_usuario</span><span class="pi">:</span> <span class="s">ans1bl3_p4ss</span>
</code></pre></div></div>

<p>Comprobamos que ahora está encriptado</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@ansible miansible]# <span class="nb">cat </span>vault.yml 
<span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span>1.1<span class="p">;</span>AES256
34646139623266333865396234626265666437383332616538363665356539373636376630303032
3235656132326633333831356463613837386635353736340a356331646439373139366438316539
35613964643632373562343032386136313631366634353666306565663163613935313435346166
3163366363313865350a633634633464353637643233353237366164363033386537356137653466
35356530636132356431626239393663613461346165396530343666626431336632
</code></pre></div></div>

<p>Ahora si podemos añadir una contraseña, por ejemplo</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">micluster</span>
  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Crear el usuario ansible</span>
      <span class="na">user</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">ansible</span>
        <span class="na">shell</span><span class="pi">:</span> <span class="s">/bin/bash</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">micomtraseña</span>
        <span class="na">generate_ssh_key</span><span class="pi">:</span> <span class="s">yes</span>
        <span class="na">ssh_key_bits</span><span class="pi">:</span> <span class="m">2048</span>
        <span class="na">ssh_key_file</span><span class="pi">:</span> <span class="s">.ssh/id_rsa</span>
</code></pre></div></div>

<p>Esto nos va a reportar un problema</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@ansible miansible]# ansible-playbook crearusuario.yml <span class="nt">-i</span> inventory.yml <span class="nt">-l</span> nodo1 <span class="nt">-C</span>

PLAY <span class="o">[</span>micluster] <span class="k">*******************************************************************************************************************************************************************************</span>

TASK <span class="o">[</span>Gathering Facts] <span class="k">*************************************************************************************************************************************************************************</span>
ok: <span class="o">[</span>nodo1]

TASK <span class="o">[</span>Crear el usuario ansible] <span class="k">****************************************************************************************************************************************************************</span>
<span class="o">[</span>WARNING]: The input password appears not to have been hashed. The <span class="s1">'password'</span> argument must be encrypted <span class="k">for </span>this module to work properly.
changed: <span class="o">[</span>nodo1]

PLAY RECAP <span class="k">*************************************************************************************************************************************************************************************</span>
nodo1                      : <span class="nv">ok</span><span class="o">=</span>2    <span class="nv">changed</span><span class="o">=</span>1    <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>0    <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
</code></pre></div></div>

<p>Hay varias soluciones, la más simple que sería usar <em>mkpasswd</em> o <em>openssl</em> para generar una clave SHA-512.
El propósito del <code class="language-plaintext highlighter-rouge">vault</code> era no depender de estas cosas, por tanto hay que modificar el playbook para indicarle que vamos a usar el playbook y que la contraseña será una variable</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">micluster</span>
  <span class="na">vars_files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">vault.yml</span>
  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Crear el usuario ansible</span>
      <span class="na">user</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">ansible</span>
        <span class="na">shell</span><span class="pi">:</span> <span class="s">/bin/bash</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_usuario</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">password_hash('sha512')</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">generate_ssh_key</span><span class="pi">:</span> <span class="s">yes</span>
        <span class="na">ssh_key_bits</span><span class="pi">:</span> <span class="m">2048</span>
        <span class="na">ssh_key_file</span><span class="pi">:</span> <span class="s">.ssh/id_rsa</span>
</code></pre></div></div>

<blockquote>
  <p>Como se aprecia, mediante una tubería hemos cifrado a SHA-512 el texto plano que teníamos en el vault.</p>
</blockquote>

<p>Puesto que vamos a usar el vault ahora el comando es distinto, puesto que tenemos que indicar que la contraseña maestra para abrirlo</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@ansible miansible]# ansible-playbook crearusuario.yml <span class="nt">-i</span> inventory.yml <span class="nt">-l</span> nodo1 <span class="nt">-C</span> <span class="nt">--ask-vault-pass</span>
Vault password: 

PLAY <span class="o">[</span>micluster] 
...
...
nodo1                      : <span class="nv">ok</span><span class="o">=</span>2    <span class="nv">changed</span><span class="o">=</span>1    <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>0    <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
</code></pre></div></div>

<p>Dirás que es un peñazo tener que poner la contraseña o que hace que lanzar una tarea automática sea imposible puesto que un prompt nos va a pedir la contraseña. Explora la opción <code class="language-plaintext highlighter-rouge">--vault-password-file ~/.vault_pass.txt</code> en la que podemos tener un archivo con los permisos correctos en el sitio correcto para que sea accesible por quien queremos.</p>

<h2 id="roles">Roles</h2>

<p>En estos momentos nos planteamos ciertas preguntas.
¿Para cada cierto tipo de acción necesitamos un playbook?
¿Qué ocurre si no quiero ejecutar un playbook completo, solo una parte?
¿Voy a juntar un montón de playbooks?</p>

<p>La respuesta es crear roles. A modo de hacer nuestro Ansible <em>modular</em>.
Vemos que estamos creando un cluster y vamos a tener que añadir tareas relativas a ellos. Pero la cuestión, no todo van a ser las mismas tareas, los mismos SO, los mismos elementos en general…</p>

<p>Lo ideal es hacer <code class="language-plaintext highlighter-rouge">roles</code> que realicen tareas generales que puedan valer para cualquier servidor. Por ejemplo: En nuestro caso haremos un rol para englobar las tareas relacionadas con SSH. Posteriormente podríamos crear otro rol para crear clúster Pacemaker, otro para servidores web…</p>

<p>Vamos a crear el primer rol, se puede hacer manualmente o mediante el comando <code class="language-plaintext highlighter-rouge">ansible-galaxy</code></p>

<h2 id="ansible-galaxy">Ansible Galaxy</h2>

<p>Etiquetado para compartir con la comunidad roles y colecciones entre otros pero además nos va a permitir crear nuestras estructuras.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>oliva@ansible miansible]<span class="nv">$ </span>ansible-galaxy init ssh
- Role ssh was created successfully
<span class="o">[</span>oliva@ansible miansible]<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> ssh
total 8
drwxrwxr-x. 10 oliva oliva  154 Sep 22 20:51 <span class="nb">.</span>
drwxrwxr-x.  3 oliva oliva   79 Sep 22 20:51 ..
drwxrwxr-x.  2 oliva oliva   22 Sep 22 20:51 defaults
drwxrwxr-x.  2 oliva oliva    6 Sep 22 20:51 files
drwxrwxr-x.  2 oliva oliva   22 Sep 22 20:51 handlers
drwxrwxr-x.  2 oliva oliva   22 Sep 22 20:51 meta
<span class="nt">-rw-rw-r--</span><span class="nb">.</span>  1 oliva oliva 1328 Sep 22 20:51 README.md
drwxrwxr-x.  2 oliva oliva   22 Sep 22 20:51 tasks
drwxrwxr-x.  2 oliva oliva    6 Sep 22 20:51 templates
drwxrwxr-x.  2 oliva oliva   39 Sep 22 20:51 tests
<span class="nt">-rw-rw-r--</span><span class="nb">.</span>  1 oliva oliva  539 Sep 22 20:51 .travis.yml
drwxrwxr-x.  2 oliva oliva   22 Sep 22 20:51 vars
</code></pre></div></div>

<blockquote>
  <p>Aqui vemos el árbol creado en la carpeta <em>ssh</em> el cual es nuestro rol para tareas de SSH.</p>
</blockquote>

<p>¿Te suena <em>tasks</em>? Son las tareas que ejecutamos en el playbook, ahora van en este archivo. Por tanto vamos a copiar el contenido del playbook, en la sección <em>tasks</em> aquí</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># tasks file for ssh</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Crear el usuario ansible</span>
  <span class="na">user</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">ansible</span>
    <span class="na">shell</span><span class="pi">:</span> <span class="s">/bin/bash</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_usuario</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">password_hash('sha512')</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">generate_ssh_key</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="na">ssh_key_bits</span><span class="pi">:</span> <span class="m">2048</span>
    <span class="na">ssh_key_file</span><span class="pi">:</span> <span class="s">.ssh/id_rsa</span>
</code></pre></div></div>

<p>Mientras que el playbook <em>crearusuario.yml</em> quedará asi</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">micluster</span>
  <span class="na">vars_files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">vault.yml</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ssh</span>
</code></pre></div></div>

<p>Ejecutamos de nuevo</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@ansible miansible]# ansible-playbook crearusuario.yml <span class="nt">-i</span> inventory.yml <span class="nt">-l</span> nodo1 <span class="nt">-C</span> <span class="nt">--ask-vault-pass</span> 
</code></pre></div></div>

<h3 id="y-vemos-que-se-completa-correctamente-ya-estamos-trabajando-con-nuestro-primer-rol">Y vemos que se completa correctamente. ¡Ya estamos trabajando con nuestro primer rol</h3>

<h2 id="tags">TAGS</h2>

<p>Necesitamos al menos agregar una segunda tarea para entender los tags.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="c1"># tasks file for ssh</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Instalar la última versión de ssh</span>
  <span class="na">yum</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">openssh-server, openssh-clients</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">latest</span>
  <span class="na">tags</span><span class="pi">:</span> <span class="s">instalar</span>
    
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Crear el usuario ansible</span>
  <span class="na">user</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">ansible</span>
    <span class="na">shell</span><span class="pi">:</span> <span class="s">/bin/bash</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_usuario</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">password_hash('sha512')</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">generate_ssh_key</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="na">ssh_key_bits</span><span class="pi">:</span> <span class="m">2048</span>
    <span class="na">ssh_key_file</span><span class="pi">:</span> <span class="s">.ssh/id_rsa</span>
  <span class="na">tags</span><span class="pi">:</span> <span class="s">usuarios</span>
</code></pre></div></div>

<p>Si volvemos a ejecutar, vamos a ver que se ejecutaran naturalmente ambas tareas.
Podemos especificar dentro del rol que tareas queremos especificar. Como sabemos que ya está instalado SSH vamos a decirle que ejecute solamente la tarea de crear el usuario ansible.
Usa el parámetro <em>-t</em> para indicar los tags.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@ansible miansible]# ansible-playbook <span class="nt">-v</span> crearusuario.yml <span class="nt">-i</span> inventory.yml <span class="nt">-l</span> nodo1 <span class="nt">-C</span> <span class="nt">-t</span> usuarios <span class="nt">--ask-vault-pass</span> 
No config file found<span class="p">;</span> using defaults
Vault password: 

PLAY <span class="o">[</span>micluster] <span class="k">************************************************************************************************************************************************************************************************************</span>

TASK <span class="o">[</span>Gathering Facts] <span class="k">******************************************************************************************************************************************************************************************************</span>
ok: <span class="o">[</span>nodo1]

TASK <span class="o">[</span>ssh : Crear el usuario ansible] <span class="k">***************************************************************************************************************************************************************************************</span>
changed: <span class="o">[</span>nodo1] <span class="o">=&gt;</span> <span class="o">{</span><span class="s2">"changed"</span>: <span class="nb">true</span><span class="o">}</span>

PLAY RECAP <span class="k">******************************************************************************************************************************************************************************************************************</span>
nodo1                      : <span class="nv">ok</span><span class="o">=</span>2    <span class="nv">changed</span><span class="o">=</span>1    <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>0    <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
</code></pre></div></div>

<blockquote>
  <p>También puedes hacer el efecto contrario <em>–skip-tags</em></p>
</blockquote>

<p>No hay manera fácil, por así decirlo, de incluirlo en el playbook. Hay formas pero son más complejas.
Esto es una de las cosas, bajo mi punto de vista, están un poco verdes.</p>

<h2 id="collections">Collections</h2>

<p>Las coleciones son contenidos que pueden ser playbooks, roles, módulos y plugins.
Básicamente se ha creado una comunidad para ahorrarte tareas como las que hasta ahora estamos haciendo (muy normales, nada específico).
Toda la info se encuentra en la <a href="https://galaxy.ansible.com">página oficial de Ansible</a>.</p>

<p>Vamos a hacer una pequeña prueba, vamos a instalar un motd de <a href="https://galaxy.ansible.com/gokev/motd-splash">GoKEV</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@ansible miansible]# ansible-galaxy <span class="nb">install </span>gokev.motd-splash <span class="nt">-p</span> /home/oliva/miansible/
Starting galaxy role <span class="nb">install </span>process
- downloading role <span class="s1">'motd-splash'</span>, owned by gokev
- downloading role from https://github.com/GoKEV/motd-splash/archive/master.tar.gz
- extracting gokev.motd-splash to /home/oliva/miansible/gokev.motd-splash
- gokev.motd-splash <span class="o">(</span>master<span class="o">)</span> was installed successfully
<span class="o">[</span>root@ansible miansible]# ll gokev.motd-splash/
total 4
drwxr-xr-x.  2 root root   22 Sep 23 21:00 defaults
drwxr-xr-x.  2 root root  163 Sep 23 21:00 files
drwxr-xr-x.  2 root root   22 Sep 23 21:00 handlers
drwxr-xr-x.  2 root root   50 Sep 23 21:00 meta
drwxr-xr-x. 10 root root  135 Sep 23 21:00 motd-splash
drwxr-xr-x.  9 root root  118 Sep 23 21:00 prep-new-vm
<span class="nt">-rw-rw-r--</span><span class="nb">.</span>  1 root root 2793 May  3 19:37 README.md
drwxr-xr-x.  2 root root   22 Sep 23 21:00 tasks
drwxr-xr-x.  2 root root  152 Sep 23 21:00 templates
drwxr-xr-x.  2 root root   39 Sep 23 21:00 tests
drwxr-xr-x.  2 root root   22 Sep 23 21:00 vars
drwxr-xr-x.  8 root root  105 Sep 23 21:00 vm-reboot
drwxr-xr-x.  8 root root  120 Sep 23 21:00 vmware-provision
</code></pre></div></div>

<p>En el <em>readme</em> indica que puedes incluiir el rol <code class="language-plaintext highlighter-rouge">gokev.motd-splash</code> en un playbook.
Añadimos a nuestro playbook</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">micluster</span>
  <span class="na">vars_files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">vault.yml</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ssh</span>
    <span class="pi">-</span> <span class="s">gokev.motd-splash</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="na">motd_template_file</span><span class="pi">:</span> <span class="s">templates/motd_redhat</span>
</code></pre></div></div>

<p>Y ejecutamos con –diff para contemplar las diferencias de las plantillas</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@ansible miansible]# ansible-playbook crearusuario.yml <span class="nt">-i</span> inventory.yml <span class="nt">-l</span> nodo1 <span class="nt">-C</span> <span class="nt">--diff</span> <span class="nt">--ask-vault-pass</span> 
Vault password: 

PLAY <span class="o">[</span>micluster] <span class="k">****************************************************************************************************************************************************************************************</span>

TASK <span class="o">[</span>Gathering Facts] <span class="k">**********************************************************************************************************************************************************************************</span>
ok: <span class="o">[</span>nodo1]

TASK <span class="o">[</span>ssh : Instalar la última versión de ssh] <span class="k">**********************************************************************************************************************************************************</span>
ok: <span class="o">[</span>nodo1]

TASK <span class="o">[</span>ssh : Crear el usuario ansible] <span class="k">*******************************************************************************************************************************************************************</span>
changed: <span class="o">[</span>nodo1]

TASK <span class="o">[</span>gokev.motd-splash : Define the custom MOTD file <span class="k">if </span>this is a CentOS system] <span class="k">***********************************************************************************************************************</span>
skipping: <span class="o">[</span>nodo1]

TASK <span class="o">[</span>gokev.motd-splash : Define the custom MOTD file <span class="k">if </span>this is a RHEL system] <span class="k">*************************************************************************************************************************</span>
skipping: <span class="o">[</span>nodo1]

TASK <span class="o">[</span>gokev.motd-splash : Define the MOTD file <span class="k">for </span>any non-RHEL and non-CENT machine] <span class="k">*******************************************************************************************************************</span>
skipping: <span class="o">[</span>nodo1]

TASK <span class="o">[</span>gokev.motd-splash : motd template] <span class="k">****************************************************************************************************************************************************************</span>
<span class="nt">---</span> before: /etc/motd
+++ after: /root/.ansible/tmp/ansible-local-4924bw_vip6k/tmpvwnd3yzd/motd_redhat
@@ <span class="nt">-0</span>,0 +1,27 @@
+@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
+@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
+@@@@@@@@@@@###########%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
+@@@@@@@@@@###############%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
+@@@@@@@@@#################@@@@@@@@@@@@       @@@@@@@@@@@@@@@@@@@@  @@@@   @@@@@   @@@@@@@@@@@@@@@@@@@@
+@@@@@@@@@##################@@@@@@@@@@@   @@@   <span class="c">#@@@@@@@@@@@@@@@@@  @@@@   @@@@@   @@@@@@@@@@@   @@@@@@</span>
+@@@#####   &amp;###############@@@@@@@@@@@   @@@@   @       @@@        @@@@   @@@@@   @       &amp;@       @@@
+@@#######      <span class="c">############@@@@@@@@@@@         @   @@@   @   @@@@  @@@@           @@@@@@   @@   @@@@@@</span>
+@@@#########                <span class="c">###@@@@@@@   @@   @@     ,,,,@   @@@@  @@@@   @@@@@   @   **   @@   @@@@@@</span>
+@@@@@###########%         <span class="c">######@@@@@@   @@@   @@       @@@        @@@@   @@@@@   @        @@&amp;    *@@@</span>
+@@@@@@@#########################@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
+@@@@@@@@@@@####################&amp;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
+@@@@@@@@@@@@@@@@#############@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
+@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
+@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
+
+                              HOSTNAME  <span class="o">===&gt;</span>  centos 
+                             IP ADDRESS <span class="o">===&gt;</span>  10.0.0.11 
+               <span class="nt">--------------------------------------------------------------------</span>
+
+               KERNEL          4.18.0-348.7.1.el8_5.x86_64
+               ARCH            x86_64
+               MACHINE         innotek GmbH :: 1.2
+               COREs           2
+
+               <span class="nt">--------------------------------------------------------------------</span>
+

changed: <span class="o">[</span>nodo1]

TASK <span class="o">[</span>gokev.motd-splash : issue template] <span class="k">***************************************************************************************************************************************************************</span>
<span class="nt">---</span> before: /etc/issue
+++ after: /root/.ansible/tmp/ansible-local-4924bw_vip6k/tmpytb0z_ud/issue
@@ <span class="nt">-1</span>,3 +1,12 @@
-<span class="se">\S</span>
<span class="nt">-Kernel</span> <span class="se">\r</span> on an <span class="se">\m</span>
+  <span class="c">###########################   WARNING!   ###########################</span>
 
+              YOU ARE ABOUT TO CONNECT TO centos!!
+
+The computer you are about to use is company owned and is intended to be used
+for official company business. As such, the company reserves the right to
+monitor all activity on all company provided equipment and services. All use
+of this machine must comply with company IT policies,  available from HR.
+
+             ALL ACTIVITIES IN THIS SYSTEM ARE MONITORED!
+
+  <span class="c">###########################   WARNING!   ###########################</span>

changed: <span class="o">[</span>nodo1]

PLAY RECAP <span class="k">**********************************************************************************************************************************************************************************************</span>
nodo1                      : <span class="nv">ok</span><span class="o">=</span>5    <span class="nv">changed</span><span class="o">=</span>3    <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>3    <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
</code></pre></div></div>

<h2 id="handlers">Handlers</h2>

<p>Te va a permitir realizar una acción en cadena, es decir, si algo ha cambiado, se reinicia el servicio, pero no lo hará si no hay un cambio.</p>

<p>Si cambiamos el archivo de configuración de SSH necesitaremos reiniciar el servicio para que los cambios sean efectivos. Por tanto, es necesario reiniciar.</p>

<p>En la <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_handlers.html">página oficial</a> podemos ver un ejemplo muy claro.</p>

<p>¡Adiós!</p>

        </div>

        
          <div class="page-share">
  <a href="https://twitter.com/intent/tweet?text=Ansible+-+Tutorial+r%C3%A1pido+completo+2%2F2%20https%3A%2F%2Fnoobchamp.github.io%2Fansible%2Flinux%2FAnsible-configuracion-inicial-2%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--twitter btn--small"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i> <span>Tweet</span></a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fnoobchamp.github.io%2Fansible%2Flinux%2FAnsible-configuracion-inicial-2%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--linkedin btn--small"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> <span>LinkedIn</span></a>
  <a href="https://reddit.com/submit?title=Ansible+-+Tutorial+r%C3%A1pido+completo+2%2F2&url=https%3A%2F%2Fnoobchamp.github.io%2Fansible%2Flinux%2FAnsible-configuracion-inicial-2%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--reddit btn--small"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i> <span>Reddit</span></a>
</div>

        

        
          
  <div class="page-comments">
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function () {
        this.page.url = 'https://noobchamp.github.io/ansible/linux/Ansible-configuracion-inicial-2/';
        this.page.identifier = 'https://noobchamp.github.io/ansible/linux/Ansible-configuracion-inicial-2/';
      };

      (function() {
        var d = document, s = d.createElement('script');
        s.src = 'https://noobchamp-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>


        

        <nav class="page-pagination" role="navigation">
  
    <a class="page-previous" href="/ansible/linux/Ansible-configuracion-inicial-1/">
      <h4 class="page-pagination-label">Anterior</h4>
      <span class="page-pagination-title">
        <i class="fas fa-arrow-left"></i> Ansible - Tutorial rápido completo 1/2

      </span>
    </a>
  

  
    <a class="page-next" href="/rhel/linux/rhel-localrepo/">
      <h4 class="page-pagination-label">Siguiente</h4>
      <span class="page-pagination-title">
        Red Hat - Instalar un repositorio local
 <i class="fas fa-arrow-right"></i>
      </span>
    </a>
  
</nav>

      </div>
    </div>
  </article>
</main>


    <footer id="footer" class="site-footer">
  <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
<div class="social-icons"><a class="social-icon" href="/atom.xml"><i class="fas fa-rss-square fa-2x" title="Feed"></i></a></div><div class="copyright">
    
      <p>&copy; 2024 Hola, soy José Oliva. Hecho con <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/mmistakes/so-simple-theme" rel="nofollow">So Simple</a>.</p>
    
  </div>
</footer>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script>
  <script src="/assets/js/custom.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,400i,700,700i|Lora:400,400i,700,700i">



  </body>
</html>
